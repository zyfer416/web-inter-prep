{% extends "base.html" %}

{% block title %}Interview Calendar - Web-Inter-Prep{% endblock %}

{% block extra_css %}
<style>
  :root{
    --pri:#0d6efd; --pri-d:#0b5ed7;
    --ok:#28a745; --ai:#6f42c1; --prac:#fd7e14; --oth:#0dcaf0;
    --bg:#f6f7fb; --ink:#2b2f33; --mut:#6b7280; --line:#e5e7eb;
  }
  body{background:var(--bg);}
  .calendar-shell{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);overflow:hidden;max-width:1100px;margin:0 auto}
  .cal-top{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#fafafa)}
  .cal-title{display:flex;align-items:center;gap:10px}
  .cal-title h3{margin:0;font-weight:700;color:var(--ink)}
  .cal-nav{display:flex;gap:8px}
  .cal-nav .btn{min-width:40px}

  .toolbar{display:flex;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:.8rem;color:var(--mut)}
  .chip .dot{width:10px;height:10px;border-radius:50%}
  .chip .dot.mock{background:var(--ok)}
  .chip .dot.ai{background:var(--ai)}
  .chip .dot.practice{background:var(--prac)}
  .chip .dot.other{background:var(--oth)}

  .stats-strip{display:flex;gap:12px;flex-wrap:wrap;padding:8px 12px;border-bottom:1px solid var(--line);background:#fff}
  .stat{background:#fafafa;border:1px solid var(--line);border-radius:10px;padding:8px 12px;min-width:120px}
  .stat .n{font-weight:700;font-size:1.1rem}

  /* Height control: no page-level long scroll */
  .calendar-shell{max-height:calc(100vh - 140px);display:flex;flex-direction:column}
  .stats-strip{flex:0 0 auto}
  .grid{flex:1 1 auto;overflow:auto}

  .grid{display:grid;grid-template-columns:repeat(7,1fr);background:var(--line)}
  .weekday{background:#343a40;color:#fff;text-align:center;padding:8px;font-weight:600;font-size:.9rem;position:sticky;top:0;z-index:1}
  .cell{background:#fff;min-height:88px;padding:6px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);position:relative;cursor:pointer}
  .cell:hover{background:#f8fafc}
  .cell.muted{background:#fafafa;color:#9aa0a6}
  .cell.today{outline:2px solid var(--pri);background:#eef5ff}
  .cell.has{border-left:4px solid #ffc107}
  .day{font-weight:700;color:#111827}

  .event{margin-top:6px;font-size:.72rem;border-radius:5px;color:#fff;padding:2px 4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block}
  .event.mock{background:var(--ok)}
  .event.ai{background:var(--ai)}
  .event.practice{background:var(--prac)}
  .event.other{background:var(--oth)}
  .more{margin-top:4px;font-size:.72rem;color:#6b7280}

  /* Drawer */
  .drawer{position:fixed;right:-420px;top:0;height:100%;width:420px;background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.12);transition:right .28s ease;z-index:1040;display:flex;flex-direction:column}
  .drawer.show{right:0}
  .drawer .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  .drawer .body{padding:16px;overflow:auto}
  .drawer .foot{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="calendar-shell">
    <div class="cal-top">
      <div class="cal-title">
        <i class="fas fa-calendar-alt text-primary"></i>
        <h3 id="calLabel">September 2025</h3>
      </div>
      <div class="cal-nav">
        <button class="btn btn-outline-secondary" id="prevBtn" title="Previous month"><i class="fas fa-chevron-left"></i></button>
        <button class="btn btn-outline-primary" id="todayBtn" title="Go to today"><i class="fas fa-home me-1"></i>Today</button>
        <button class="btn btn-outline-secondary" id="nextBtn" title="Next month"><i class="fas fa-chevron-right"></i></button>
      </div>
      <div class="toolbar">
        <button class="btn btn-outline-primary" id="exportBtn"><i class="fas fa-download me-1"></i>Export</button>
        <button class="btn btn-primary" id="addBtn"><i class="fas fa-plus me-1"></i>Add</button>
      </div>
    </div>

    <div class="stats-strip">
      <div class="stat"><div class="n" id="statTotal">0</div><div>Total</div></div>
      <div class="stat"><div class="n" id="statMonth">0</div><div>This month</div></div>
      <div class="stat"><div class="n" id="statUpcoming">0</div><div>Upcoming</div></div>
      <div class="stat"><div class="n" id="statDone">0</div><div>Completed</div></div>
      <span class="chip"><span class="dot mock"></span>Mock</span>
      <span class="chip"><span class="dot ai"></span>AI</span>
      <span class="chip"><span class="dot practice"></span>Practice</span>
      <span class="chip"><span class="dot other"></span>Other</span>
    </div>

    <div class="grid" id="grid">
      <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
      <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
      <div id="cells"></div>
    </div>
  </div>
</div>

<!-- Right drawer for Add/Edit -->
<div class="drawer" id="drawer">
  <div class="head">
    <strong id="drawerTitle">Add interview</strong>
    <button class="btn btn-sm btn-outline-secondary" id="closeDrawer"><i class="fas fa-times"></i></button>
  </div>
  <div class="body">
    <form id="form">
      <div class="mb-3">
        <label class="form-label">Title</label>
        <input class="form-control" id="fTitle" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Type</label>
        <select class="form-select" id="fType" required>
          <option value="mock">Mock</option>
          <option value="ai">AI</option>
          <option value="practice">Practice</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" id="fDate" required>
        </div>
        <div class="col-6">
          <label class="form-label">Time</label>
          <input type="time" class="form-control" id="fTime" required>
        </div>
      </div>
      <div class="mb-3 mt-2">
        <label class="form-label">Duration (min)</label>
        <input type="number" class="form-control" id="fDur" value="30" min="15" max="180">
      </div>
      <div class="mb-3">
        <label class="form-label">Notes</label>
        <textarea class="form-control" id="fNotes" rows="3"></textarea>
      </div>
      <input type="hidden" id="fId">
    </form>
  </div>
  <div class="foot">
    <button class="btn btn-outline-danger d-none" id="delBtn"><i class="fas fa-trash me-1"></i>Delete</button>
    <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
    <button class="btn btn-primary" id="saveBtn">Save</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const CalendarUI = (() => {
  let state = {
    today: new Date(),
    cursor: new Date(),
    items: []
  };

  // DOM refs
  const el = {
    label: () => document.getElementById('calLabel'),
    cells: () => document.getElementById('cells'),
    drawer: () => document.getElementById('drawer'),
    form: () => document.getElementById('form'),
    id: () => document.getElementById('fId'),
    title: () => document.getElementById('fTitle'),
    type: () => document.getElementById('fType'),
    date: () => document.getElementById('fDate'),
    time: () => document.getElementById('fTime'),
    dur: () => document.getElementById('fDur'),
    notes: () => document.getElementById('fNotes'),
    delBtn: () => document.getElementById('delBtn'),
    statTotal: () => document.getElementById('statTotal'),
    statMonth: () => document.getElementById('statMonth'),
    statUpcoming: () => document.getElementById('statUpcoming'),
    statDone: () => document.getElementById('statDone'),
  };

  // Storage
  const load = () => {
    const raw = localStorage.getItem('interviewCalendar');
    if (raw) state.items = JSON.parse(raw);
    if (!raw) {
      state.items = [
        {id:1,title:'Mock DS&A',type:'mock',date:todayStr(0),time:'14:00',duration:45,notes:'Arrays, DP'},
        {id:2,title:'AI System Design',type:'ai',date:todayStr(3),time:'11:00',duration:40,notes:'Caching, queues'}
      ];
      save();
    }
  };
  const save = () => localStorage.setItem('interviewCalendar', JSON.stringify(state.items));
  const todayStr = (offsetDays=0) => {
    const d = new Date(); d.setDate(d.getDate()+offsetDays);
    return d.toISOString().split('T')[0];
  };

  // Helpers
  const fmtDate = (y,m,day) => `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

  // Render calendar grid
  const render = () => {
    const y = state.cursor.getFullYear();
    const m = state.cursor.getMonth();
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    el.label().textContent = `${monthNames[m]} ${y}`;

    const first = new Date(y,m,1);
    const last = new Date(y,m+1,0);
    const startOffset = first.getDay();
    const totalDays = last.getDate();

    const host = el.cells();
    host.innerHTML = '';

    for (let i=0;i<startOffset;i++) host.appendChild(cell(0,true));

    for (let day=1; day<=totalDays; day++){
      const dateStr = fmtDate(y,m,day);
      const events = state.items.filter(it => it.date === dateStr);
      host.appendChild(cell(day,false,events));
    }

    const need = 42 - host.children.length;
    for (let i=0;i<need;i++) host.appendChild(cell(0,true));

    updateStats();
  };

  // Build a day cell
  const cell = (day, muted=false, events=[]) => {
    const d = document.createElement('div');
    d.className = 'cell' + (muted?' muted':'') + (events.length?' has':'');
    if (!muted) {
      const y = state.cursor.getFullYear(), m = state.cursor.getMonth();
      const dateStr = fmtDate(y,m,day);
      const header = document.createElement('div');
      header.className = 'day';
      header.textContent = day;
      d.appendChild(header);

      const now = new Date();
      if (y===now.getFullYear() && m===now.getMonth() && day===now.getDate()) d.classList.add('today');

      const maxRows = 3;
      events.slice(0, maxRows).forEach(ev => {
        const e = document.createElement('div');
        e.className = `event ${ev.type}`;
        e.textContent = `${ev.time} â€¢ ${ev.title}`;
        e.title = `${ev.title} at ${ev.time}`;
        e.addEventListener('click', (e2) => { e2.stopPropagation(); openDrawer(ev); });
        d.appendChild(e);
      });
      if (events.length > maxRows) {
        const more = document.createElement('div');
        more.className = 'more';
        more.textContent = `+${events.length - maxRows} more`;
        more.addEventListener('click', (e2) => { e2.stopPropagation(); openDrawer({ date: dateStr }); });
        d.appendChild(more);
      }

      d.addEventListener('click', () => openDrawer({ date: dateStr, time: '10:00', duration: 30, type: 'other' }));
    }
    return d;
  };

  // Stats
  const updateStats = () => {
    const y = state.cursor.getFullYear();
    const m = state.cursor.getMonth();
    const monthCnt = state.items.filter(it => {
      const d = new Date(it.date);
      return d.getFullYear()===y && d.getMonth()===m;
    }).length;

    const today = new Date().toISOString().split('T')[0];
    const done = state.items.filter(it => it.date < today).length;
    const upcoming = state.items.filter(it => it.date >= today).length;

    el.statTotal().textContent = state.items.length;
    el.statMonth().textContent = monthCnt;
    el.statUpcoming().textContent = upcoming;
    el.statDone().textContent = done;
  };

  // Drawer logic
  const openDrawer = (obj) => {
    el.form().reset();
    el.id().value = obj.id || '';
    el.title().value = obj.title || '';
    el.type().value = obj.type || 'other';
    el.date().value = obj.date || new Date().toISOString().split('T')[0];
    el.time().value = obj.time || '10:00';
    el.dur().value = obj.duration || 30;
    el.notes().value = obj.notes || '';
    el.delBtn().classList.toggle('d-none', !obj.id);

    document.getElementById('drawerTitle').textContent = obj.id ? 'Edit interview' : 'Add interview';
    el.drawer().classList.add('show');
  };
  const closeDrawer = () => el.drawer().classList.remove('show');

  const saveItem = () => {
    if (!el.form().checkValidity()) { el.form().reportValidity(); return; }
    const item = {
      id: el.id().value ? Number(el.id().value) : Date.now(),
      title: el.title().value.trim(),
      type: el.type().value,
      date: el.date().value,
      time: el.time().value,
      duration: Number(el.dur().value || 30),
      notes: el.notes().value.trim()
    };
    const idx = state.items.findIndex(i => i.id === item.id);
    if (idx >= 0) state.items[idx] = item; else state.items.push(item);
    save(); render(); closeDrawer();
  };

  const delItem = () => {
    const id = Number(el.id().value);
    state.items = state.items.filter(i => i.id !== id);
    save(); render(); closeDrawer();
  };

  // Bindings
  const bind = () => {
    document.getElementById('prevBtn').addEventListener('click', () => { state.cursor.setMonth(state.cursor.getMonth()-1); render(); });
    document.getElementById('nextBtn').addEventListener('click', () => { state.cursor.setMonth(state.cursor.getMonth()+1); render(); });
    document.getElementById('todayBtn').addEventListener('click', () => { state.cursor = new Date(); render(); });
    document.getElementById('addBtn').addEventListener('click', () => openDrawer({}));
    document.getElementById('exportBtn').addEventListener('click', exportData);
    document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
    document.getElementById('cancelBtn').addEventListener('click', closeDrawer);
    document.getElementById('saveBtn').addEventListener('click', saveItem);
    el.delBtn().addEventListener('click', delItem);
  };

  const exportData = () => {
    const blob = new Blob([JSON.stringify(state.items,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'interview-calendar.json'; a.click();
    URL.revokeObjectURL(url);
  };

  const init = () => { load(); bind(); render(); };

  return { init };
})();

document.addEventListener('DOMContentLoaded', CalendarUI.init);
</script>
{% endblock %}
