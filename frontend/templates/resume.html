{% extends "base.html" %}
{% block title %}Resume Builder - Web-Inter-Prep{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
          <i class="fas fa-file-alt me-2"></i>Resume Builder
        </div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">Target Role</label>
            <input id="targetRole" class="form-control" placeholder="e.g., Backend Engineer">
          </div>
          <div class="mb-2">
            <label class="form-label">Seniority</label>
            <select id="seniority" class="form-select">
              <option>Fresher</option><option>Junior</option><option>Mid</option><option>Senior</option>
            </select>
          </div>
          <hr>
          <div class="mb-2">
            <label class="form-label">Profile</label>
            <textarea id="profile" rows="3" class="form-control" placeholder='{"name":"Ayush","email":"ayush@x.com","phone":"+91-9..","location":"Delhi","linkedin":"...","github":"...","summary":"CS undergrad..."}'></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Skills (JSON array)</label>
            <textarea id="skills" rows="2" class="form-control" placeholder='["Python","Flask","SQL","AWS","Docker"]'></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Experience (JSON array)</label>
            <textarea id="experience" rows="4" class="form-control" placeholder='[{"company":"ABC","role":"Backend Intern","start":"06/2024","end":"08/2024","desc":"Built APIs","impact":"Reduced latency 30%"}]'></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Projects (JSON array)</label>
            <textarea id="projects" rows="4" class="form-control" placeholder='[{"name":"Microplastic Detector","tech":["YOLOv8","Flask"],"desc":"CV pipeline","impact":"Detected 95% mAP","links":["https://github.com/..."]}]'></textarea>
          </div>
          <div class="mb-2">
            <label class="form-label">Education (JSON array)</label>
            <textarea id="education" rows="3" class="form-control" placeholder='[{"degree":"B.Tech CSE","school":"XYZ University","year":"2027","score":"8.7 CGPA"}]'></textarea>
          </div>
          <div class="d-flex gap-2">
            <button id="buildBtn" class="btn btn-success"><i class="fas fa-wand-magic me-2"></i>Build Resume</button>
            <button id="sampleBtn" class="btn btn-outline-secondary">Fill Sample</button>
          </div>
          <div id="tipsBox" class="alert alert-info mt-3 d-none"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between">
          <span><i class="fas fa-eye me-2"></i>Preview</span>
          <div class="d-flex gap-2">
            <button id="copyBtn" class="btn btn-sm btn-light"><i class="fas fa-copy me-1"></i>Copy HTML</button>
            <button id="pdfBtn" class="btn btn-sm btn-outline-light"><i class="fas fa-file-pdf me-1"></i>Download PDF</button>
          </div>
        </div>
        <div class="card-body">
          <div id="highlights" class="mb-3"></div>
          <div id="resumeHtml" style="min-height:400px;border:1px dashed #d0d7de;padding:12px;border-radius:8px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function showToast(title, msg){
  const id='simpleToast'; let el=document.getElementById(id);
  if(!el){ el=document.createElement('div'); el.id=id; el.style.position='fixed'; el.style.right='20px'; el.style.bottom='20px'; el.style.zIndex='1080'; document.body.appendChild(el); }
  const item=document.createElement('div');
  item.className='toast align-items-center text-bg-dark border-0 show';
  item.role='alert'; item.style.minWidth='280px';
  item.innerHTML=`<div class="d-flex"><div class="toast-body"><strong>${title}</strong><br>${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  el.appendChild(item); setTimeout(()=>item.remove(),3000);
}

function parseJSON(id, fallback){ try{ const v=document.getElementById(id).value.trim(); return v?JSON.parse(v):fallback; }catch(e){ showToast("Parse error", id+": "+e.message); return fallback; } }

document.getElementById('sampleBtn').addEventListener('click', ()=>{
  document.getElementById('targetRole').value = "Backend Engineer";
  document.getElementById('seniority').value = "Fresher";
  document.getElementById('profile').value = JSON.stringify({name:"Ayush",email:"ayush@example.com",phone:"+91-9xxxx",location:"Delhi",linkedin:"https://linkedin.com/in/ayush",github:"https://github.com/ayush",summary:"CS undergrad focused on backend, cloud and ML-driven projects."}, null, 2);
  document.getElementById('skills').value = JSON.stringify(["Python","Flask","FastAPI","PostgreSQL","Redis","Docker","AWS","GitHub Actions"], null, 2);
  document.getElementById('experience').value = JSON.stringify([{company:"Finlatics",role:"Backend Intern",start:"06/2024",end:"08/2024",desc:"Implemented REST APIs and caching",impact:"Improved p95 by 35%"}], null, 2);
  document.getElementById('projects').value = JSON.stringify([{name:"Microplastic Detection",tech:["YOLOv8","Flask"],desc:"Microscopy image CV pipeline",impact:"mAP@50 of 0.95 on test set",links:["https://github.com/..."]},{name:"Agri Yield Platform",tech:["React","Flask","LightGBM","BERT"],desc:"Multilingual advisory & yield prediction",impact:"Reduced input costs by 12% in pilots"}], null, 2);
  document.getElementById('education').value = JSON.stringify([{degree:"B.Tech CSE",school:"XYZ University",year:"2027",score:"8.7 CGPA"}], null, 2);
});

document.getElementById('buildBtn').addEventListener('click', async ()=>{
  const btn = document.getElementById('buildBtn');
  const prev = btn.innerHTML; btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Building...';
  try{
    const body = {
      target: document.getElementById('targetRole').value.trim() || "Software Engineer",
      seniority: document.getElementById('seniority').value || "Fresher",
      profile: parseJSON('profile', {}),
      skills: parseJSON('skills', []),
      experience: parseJSON('experience', []),
      projects: parseJSON('projects', []),
      education: parseJSON('education', [])
    };
    const res = await fetch('/api/gemini/resume', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Failed to build");
    // Tips
    const tipsBox = document.getElementById('tipsBox');
    const tips = (data.result.improvements||[]).map(s=>`<li>${s}</li>`).join('');
    tipsBox.classList.toggle('d-none', tips.length===0);
    tipsBox.innerHTML = tips? `<ul class="mb-0">${tips}</ul>` : '';
    // Highlights
    const hi = (data.result.highlights||[]).map(s=>`<li>${s}</li>`).join('');
    document.getElementById('highlights').innerHTML = hi? `<div class="alert alert-secondary"><div class="fw-semibold mb-1">Highlights</div><ul class="mb-0">${hi}</ul></div>` : '';
    // HTML
    document.getElementById('resumeHtml').innerHTML = data.result.html || "<p>No content</p>";
  }catch(e){
    console.error(e); showToast("Resume error", e.message);
  }finally{
    btn.innerHTML = prev; btn.disabled = false;
  }
});

document.getElementById('copyBtn').addEventListener('click', ()=>{
  const html = document.getElementById('resumeHtml').innerHTML || '';
  navigator.clipboard.writeText(html).then(()=> showToast("Copied", "Resume HTML copied."));
});

document.getElementById('pdfBtn').addEventListener('click', ()=>{
  const w = window.open('', '_blank');
  const html = document.getElementById('resumeHtml').innerHTML || '';
  w.document.write(`<html><head><title>Resume</title>
    <style>body{font-family:Inter,system-ui,Arial;margin:24px} h5{margin:.25rem 0} section{margin-bottom:10px}</style>
  </head><body>${html}</body></html>`);
  w.document.close(); w.focus(); w.print();
});
</script>
{% endblock %}
