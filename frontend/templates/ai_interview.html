{% extends "base.html" %}
{% block title %}AI Interview - Web-Inter-Prep{% endblock %}
{% block content %}

<div class="container py-4">
  <h2 class="mb-3">AI Interview</h2>

  <!-- Question card -->
  <div class="card mb-3">
    <div class="card-body">
      <div id="topic" class="text-muted small"></div>
      <div id="question" class="fs-5 fw-semibold">Loading question...</div>

      <textarea id="answerBox" name="answer" rows="6" class="form-control mt-3" placeholder="Type your answer here..." required></textarea>
      <div class="mt-3 d-flex gap-2">
        <button id="submitBtn" class="btn btn-primary" type="button">Submit Answer</button>
        <a class="btn btn-outline-secondary" href="/mock/results">End Interview</a>
      </div>
    </div>
  </div>

  <!-- Feedback -->
  <div id="feedback"></div>
</div>

<script>
let currentQuestion = "";
let currentTopic = "";

async function startInterview() {
  try {
    const role = "Software Engineer";   // or read from query/form later
    const level = "Fresher";
    const company = "Any";
    const res = await fetch("/api/ai-interview/start", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ role, level, company })
    });
    const data = await res.json();
    if (!data.ok) { alert(data.error || "Failed to start interview"); return; }
    currentQuestion = data.question || "Tell me about yourself.";
    currentTopic = data.topic || "General";
    renderQuestion();
  } catch (e) {
    console.error(e);
    alert("Could not start interview.");
  }
}

function renderQuestion() {
  document.getElementById("question").innerText = currentQuestion;
  document.getElementById("topic").innerText = currentTopic ? `Topic: ${currentTopic}` : "";
}

function renderFeedback(ev) {
  const bullets = (arr)=> (arr||[]).map(x=>`<li>${x}</li>`).join("");
  document.getElementById("feedback").innerHTML = `
    <div class="card">
      <div class="card-body">
        <div><strong>Score:</strong> ${ev.score_10 ?? "-"} / 10</div>
        <div><strong>Verdict:</strong> ${ev.verdict ?? "-"}</div>
        <div class="row mt-2">
          <div class="col-md-6">
            <strong>Strengths</strong>
            <ul>${bullets(ev.strengths)}</ul>
          </div>
          <div class="col-md-6">
            <strong>Improvements</strong>
            <ul>${bullets(ev.improvements)}</ul>
          </div>
        </div>
        <div class="mt-2">
          <strong>Ideal answer</strong>
          <div class="mt-1">${(ev.ideal_answer || "").replace(/\n/g, "<br>")}</div>
        </div>
      </div>
    </div>`;
}

async function submitAnswer() {
  const box = document.getElementById("answerBox");
  const btn = document.getElementById("submitBtn");
  const ans = box.value.trim();
  if (!ans) { alert("Write your answer"); return; }

  btn.disabled = true;
  const original = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Evaluating...';

  try {
    const res = await fetch("/api/ai-interview/answer", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ question: currentQuestion, answer: ans })
    });
    const data = await res.json();
    if (!data.ok) { alert(data.error || "Failed to evaluate"); return; }
    renderFeedback(data.evaluation);
    currentQuestion = data.next_question || "";
    currentTopic = data.next_topic || "";
    box.value = "";
    if (currentQuestion) renderQuestion();
    else document.getElementById("question").innerText = "Interview complete.";
  } catch (e) {
    console.error(e);
    alert("Submit failed.");
  } finally {
    btn.innerHTML = original;
    btn.disabled = false;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("submitBtn").addEventListener("click", submitAnswer);
  startInterview();
});
</script>

{% endblock %}
