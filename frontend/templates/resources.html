{% extends "base.html" %}

{% block title %}Resume Builder - Web-Inter-Prep{% endblock %}

{% block extra_css %}
<style>
    .resume-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .step {
        display: flex;
        align-items: center;
        margin: 0 1rem;
        opacity: 0.5;
        transition: all 0.3s ease;
    }
    
    .step.active {
        opacity: 1;
        transform: scale(1.05);
    }
    
    .step.completed {
        opacity: 1;
        color: #28a745;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        font-weight: bold;
    }
    
    .step.active .step-number {
        background: #007bff;
    }
    
    .step.completed .step-number {
        background: #28a745;
    }
    
    .resume-form {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .form-section {
        display: none;
    }
    
    .form-section.active {
        display: block;
        animation: fadeInUp 0.5s ease;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .section-title {
        color: #495057;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-floating {
        margin-bottom: 1rem;
    }
    
    .skill-tag {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        margin: 0.25rem;
        font-size: 0.875rem;
        border: 1px solid #bbdefb;
    }
    
    .skill-tag .remove-skill {
        margin-left: 0.5rem;
        cursor: pointer;
        color: #f44336;
    }
    
    .experience-item, .education-item, .project-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid #007bff;
    }
    
    .add-item-btn {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    
    .add-item-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }
    
    .resume-preview {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-top: 2rem;
    }
    
    .preview-header {
        text-align: center;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .preview-section {
        margin-bottom: 1.5rem;
    }
    
    .preview-section h5 {
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 0.75rem;
    }
    
    .ats-score {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .recommendations {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .recommendation-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid #007bff;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .progress-bar {
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(135deg, #007bff, #0056b3);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }
    
    .btn-outline-primary {
        border: 2px solid #007bff;
        color: #007bff;
        background: transparent;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
        background: #007bff;
        color: white;
        transform: translateY(-2px);
    }
</style>

{% endblock %}

{% block content %}
<div class="resume-header">
    <div class="container text-center">
        <i class="fas fa-file-alt display-1 mb-3"></i>
        <h1 class="display-4 fw-bold">AI-Powered Resume Builder</h1>
        <p class="lead">Create ATS-friendly resumes with AI recommendations</p>
    </div>
</div>

<div class="container">
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <span>Personal Info</span>
        </div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <span>Experience</span>
        </div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <span>Education</span>
        </div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <span>Skills & Projects</span>
        </div>
        <div class="step" data-step="5">
            <div class="step-number">5</div>
            <span>Review & Generate</span>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress mb-4" style="height: 8px;">
        <div class="progress-bar" role="progressbar" style="width: 20%" id="progressBar"></div>
    </div>

    <!-- Resume Form -->
    <div class="resume-form">
        <form id="resumeForm">
            <!-- Step 1: Personal Information -->
            <div class="form-section active" id="step1">
                <h3 class="section-title">
                    <i class="fas fa-user me-2"></i>Personal Information
        </h3>
        <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="firstName" name="firstName" placeholder="First Name" required>
                            <label for="firstName">First Name</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="lastName" name="lastName" placeholder="Last Name" required>
                            <label for="lastName">Last Name</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
                            <label for="email">Email</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="tel" class="form-control" id="phone" name="phone" placeholder="Phone">
                            <label for="phone">Phone Number</label>
                        </div>
                </div>
            </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="location" name="location" placeholder="Location">
                            <label for="location">Location (City, State)</label>
                </div>
            </div>
                    <div class="col-md-6">
                        <div class="form-floating mb-3">
                            <input type="url" class="form-control" id="linkedin" name="linkedin" placeholder="LinkedIn URL">
                            <label for="linkedin">LinkedIn Profile</label>
                </div>
            </div>
        </div>
                <div class="form-floating mb-3">
                    <textarea class="form-control" id="summary" name="summary" placeholder="Professional Summary" style="height: 100px"></textarea>
                    <label for="summary">Professional Summary</label>
        </div>
    </div>

            <!-- Step 2: Work Experience -->
            <div class="form-section" id="step2">
                <h3 class="section-title">
                    <i class="fas fa-briefcase me-2"></i>Work Experience
                </h3>
                <div id="experienceContainer">
                    <div class="experience-item">
        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="jobTitle[]" placeholder="Job Title" required>
                                    <label>Job Title</label>
                    </div>
                        </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="company[]" placeholder="Company" required>
                                    <label>Company</label>
                    </div>
                </div>
            </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="startDate[]" placeholder="Start Date" required>
                                    <label>Start Date (MM/YYYY)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="endDate[]" placeholder="End Date">
                                    <label>End Date (MM/YYYY or "Present")</label>
        </div>
        </div>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control" name="description[]" placeholder="Job Description" style="height: 100px" required></textarea>
                            <label>Job Description & Achievements</label>
                    </div>
                </div>
            </div>
                <button type="button" class="btn add-item-btn" onclick="addExperience()">
                    <i class="fas fa-plus me-2"></i>Add Experience
                </button>
        </div>
        
            <!-- Step 3: Education -->
            <div class="form-section" id="step3">
                <h3 class="section-title">
                    <i class="fas fa-graduation-cap me-2"></i>Education
                </h3>
                <div id="educationContainer">
                    <div class="education-item">
                <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="degree[]" placeholder="Degree" required>
                                    <label>Degree</label>
                                </div>
                        </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="school[]" placeholder="School/University" required>
                                    <label>School/University</label>
                    </div>
                        </div>
                    </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="gradYear[]" placeholder="Graduation Year">
                                    <label>Graduation Year</label>
                        </div>
                    </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" name="gpa[]" placeholder="GPA (Optional)">
                                    <label>GPA (Optional)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                <button type="button" class="btn add-item-btn" onclick="addEducation()">
                    <i class="fas fa-plus me-2"></i>Add Education
                </button>
            </div>

            <!-- Step 4: Skills and Projects -->
            <div class="form-section" id="step4">
                <h3 class="section-title">
                    <i class="fas fa-code me-2"></i>Skills & Projects
                </h3>
                
                <div class="mb-4">
                    <label class="form-label">Technical Skills</label>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="skillInput" placeholder="Add a skill">
                        <button type="button" class="btn btn-outline-primary" onclick="addSkill()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="skillsContainer"></div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Projects</label>
                    <div id="projectsContainer">
                        <div class="project-item">
        <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" name="projectName[]" placeholder="Project Name" required>
                                        <label>Project Name</label>
                                    </div>
                        </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="url" class="form-control" name="projectUrl[]" placeholder="Project URL">
                                        <label>Project URL (Optional)</label>
                    </div>
                </div>
                        </div>
                            <div class="form-floating mb-3">
                                <textarea class="form-control" name="projectDescription[]" placeholder="Project Description" style="height: 80px" required></textarea>
                                <label>Project Description</label>
                    </div>
                </div>
            </div>
                    <button type="button" class="btn add-item-btn" onclick="addProject()">
                        <i class="fas fa-plus me-2"></i>Add Project
                    </button>
                            </div>
        </div>

            <!-- Step 5: Review and Generate -->
            <div class="form-section" id="step5">
                <h3 class="section-title">
                    <i class="fas fa-eye me-2"></i>Review & Generate Resume
                </h3>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="resume-preview" id="resumePreview">
                            <div class="preview-header">
                                <h2 id="previewName">Your Name</h2>
                                <p id="previewContact">Email • Phone • Location</p>
                            </div>
                            
                            <div class="preview-section">
                                <h5>Professional Summary</h5>
                                <p id="previewSummary">Your professional summary will appear here...</p>
                            </div>
                            
                            <div class="preview-section">
                                <h5>Experience</h5>
                                <div id="previewExperience">Your work experience will appear here...</div>
                        </div>
                            
                            <div class="preview-section">
                                <h5>Education</h5>
                                <div id="previewEducation">Your education will appear here...</div>
                    </div>
                            
                            <div class="preview-section">
                                <h5>Skills</h5>
                                <div id="previewSkills">Your skills will appear here...</div>
                            </div>
                            
                            <div class="preview-section">
                                <h5>Projects</h5>
                                <div id="previewProjects">Your projects will appear here...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-font me-2"></i>Typography</h5>
                                <div class="mb-2">
                                    <label class="form-label">Name Font</label>
                                    <select id="fontName" class="form-select">
                                        <option value="'Inter', sans-serif" selected>Inter</option>
                                        <option value="'Georgia', serif">Georgia</option>
                                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                        <option value="'Garamond', serif">Garamond</option>
                                        <option value="'Montserrat', sans-serif">Montserrat</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Section Headings Font</label>
                                    <select id="fontHeadings" class="form-select">
                                        <option value="'Inter', sans-serif" selected>Inter</option>
                                        <option value="'Poppins', sans-serif">Poppins</option>
                                        <option value="'Roboto Slab', serif">Roboto Slab</option>
                                        <option value="'Merriweather', serif">Merriweather</option>
                                    </select>
                            </div>
                                <div class="mb-2">
                                    <label class="form-label">Body Font</label>
                                    <select id="fontBody" class="form-select">
                                        <option value="'Inter', sans-serif" selected>Inter</option>
                                        <option value="'Open Sans', sans-serif">Open Sans</option>
                                        <option value="'Lato', sans-serif">Lato</option>
                                        <option value="'Source Serif Pro', serif">Source Serif Pro</option>
                                    </select>
                            </div>
                                <small class="text-muted">Fonts are applied live to the preview.</small>
                        </div>
                    </div>
                        <div class="d-grid gap-2">
                            <button type="button" id="aiGenerateBtn" class="btn btn-primary">
                                <i class="fas fa-robot me-2"></i>Generate Using AI (basic info only)
                            </button>
                            <button type="button" id="downloadBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-download me-2"></i>Download / Print
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-primary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="changeStep(1)">
                    Next<i class="fas fa-arrow-right ms-2"></i>
                </button>
                <!-- <button type="button" class="btn btn-success" id="generateBtn" onclick="generateResume()" style="display: none;">
                    <i class="fas fa-magic me-2"></i>Generate Preview
                </button> -->
            </div>
        </form>
        </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">AI is analyzing your resume...</p>
    </div>
</div>
{% endblock %}
<style>
@media print {
  /* Hide everything by default */
  body * { visibility: hidden !important; }

  /* Show only the resume preview area */
  #resumePreview, #resumePreview * {
    visibility: visible !important;
  }

  /* Position the preview at the top-left for clean pages */
  #resumePreview {
    position: absolute;
    left: 0;
    top: 0;
    width: 210mm;           /* target A4 width */
    max-width: 210mm;
    margin: 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    padding: 16mm !important;  /* inner page margin */
    font-size: inherit;
  }

  /* Remove header banner and any non-preview spacing */
  .resume-header, .step-indicator, .progress, .resume-form, .loading-spinner, .container > .alert {
    display: none !important;
  }

  /* Avoid colored backgrounds in print */
  .preview-header { border-bottom: 1px solid #999 !important; }
}
</style>

{% block extra_js %}
<script>
// Resume Builder JavaScript
let currentStep = 1;
let skills = [];
let resumeData = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeResumeBuilder();
});

function initializeResumeBuilder() {
    // Add event listeners for form inputs
    document.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', updatePreview);
    });
    
    // Skill input enter key
    document.getElementById('skillInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addSkill();
        }
    });
}

function changeStep(direction) {
    const totalSteps = 5;
    const newStep = currentStep + direction;
    
    if (newStep < 1 || newStep > totalSteps) return;
    
    // Hide current step
    document.getElementById(`step${currentStep}`).classList.remove('active');
    document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
    
    // Show new step
    currentStep = newStep;
    document.getElementById(`step${currentStep}`).classList.add('active');
    document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
    
    // Update progress bar
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
    
    // Update navigation buttons
    updateNavigationButtons();
    
    // Update preview if on step 5
    if (currentStep === 5) {
        updatePreview();
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const generateBtn = document.getElementById('generateBtn');
    
    prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    
    if (currentStep < 5) {
        nextBtn.style.display = 'block';
        generateBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'none';
        generateBtn.style.display = 'block';
    }
}

function addExperience() {
    const container = document.getElementById('experienceContainer');
    const newExperience = document.createElement('div');
    newExperience.className = 'experience-item';
    newExperience.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="jobTitle[]" placeholder="Job Title" required>
                    <label>Job Title</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="company[]" placeholder="Company" required>
                    <label>Company</label>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="startDate[]" placeholder="Start Date" required>
                    <label>Start Date (MM/YYYY)</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="endDate[]" placeholder="End Date">
                    <label>End Date (MM/YYYY or "Present")</label>
                </div>
            </div>
        </div>
        <div class="form-floating mb-3">
            <textarea class="form-control" name="description[]" placeholder="Job Description" style="height: 100px" required></textarea>
            <label>Job Description & Achievements</label>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">
            <i class="fas fa-trash me-1"></i>Remove
        </button>
    `;
    container.appendChild(newExperience);
    
    // Add event listeners to new inputs
    newExperience.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', updatePreview);
    });
}

function addEducation() {
    const container = document.getElementById('educationContainer');
    const newEducation = document.createElement('div');
    newEducation.className = 'education-item';
    newEducation.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="degree[]" placeholder="Degree" required>
                    <label>Degree</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="school[]" placeholder="School/University" required>
                    <label>School/University</label>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="gradYear[]" placeholder="Graduation Year">
                    <label>Graduation Year</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="gpa[]" placeholder="GPA (Optional">
                    <label>GPA (Optional)</label>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">
            <i class="fas fa-trash me-1"></i>Remove
        </button>
    `;
    container.appendChild(newEducation);
    
    // Add event listeners to new inputs
    newEducation.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', updatePreview);
    });
}

function addProject() {
    const container = document.getElementById('projectsContainer');
    const newProject = document.createElement('div');
    newProject.className = 'project-item';
    newProject.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" name="projectName[]" placeholder="Project Name" required>
                    <label>Project Name</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input type="url" class="form-control" name="projectUrl[]" placeholder="Project URL">
                    <label>Project URL (Optional)</label>
                </div>
            </div>
        </div>
        <div class="form-floating mb-3">
            <textarea class="form-control" name="projectDescription[]" placeholder="Project Description" style="height: 80px" required></textarea>
            <label>Project Description</label>
        </div>
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeItem(this)">
            <i class="fas fa-trash me-1"></i>Remove
        </button>
    `;
    container.appendChild(newProject);
    
    // Add event listeners to new inputs
    newProject.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', updatePreview);
    });
}

function removeItem(button) {
    button.closest('.experience-item, .education-item, .project-item').remove();
    updatePreview();
}

function addSkill() {
    const skillInput = document.getElementById('skillInput');
    const skill = skillInput.value.trim();
    
    if (skill && !skills.includes(skill)) {
        skills.push(skill);
        skillInput.value = '';
        updateSkillsDisplay();
        updatePreview();
    }
}

function removeSkill(skill) {
    skills = skills.filter(s => s !== skill);
    updateSkillsDisplay();
    updatePreview();
}

function updateSkillsDisplay() {
    const container = document.getElementById('skillsContainer');
    container.innerHTML = skills.map(skill => `
        <span class="skill-tag">
            ${skill}
            <span class="remove-skill" onclick="removeSkill('${skill}')">×</span>
        </span>
    `).join('');
}

function updatePreview() {
    // Always sync preview so user can see progress live
    
    // Collect form data
    const formData = new FormData(document.getElementById('resumeForm'));
    const data = {};
    
    // Personal info
    data.firstName = document.getElementById('firstName').value;
    data.lastName = document.getElementById('lastName').value;
    data.email = document.getElementById('email').value;
    data.phone = document.getElementById('phone').value;
    data.location = document.getElementById('location').value;
    data.linkedin = document.getElementById('linkedin').value;
    data.summary = document.getElementById('summary').value;
    
    // Experience
    data.experience = [];
    document.querySelectorAll('.experience-item').forEach(item => {
        const jobTitle = item.querySelector('input[name="jobTitle[]"]').value;
        const company = item.querySelector('input[name="company[]"]').value;
        const startDateRaw = item.querySelector('input[name="startDate[]"]').value;
        const endDateRaw = item.querySelector('input[name="endDate[]"]').value;
        const description = item.querySelector('textarea[name="description[]"]').value;
        const startDate = normalizeMonthYear(startDateRaw);
        const endDate = normalizeMonthYear(endDateRaw, true);
        
        if (jobTitle && company) {
            data.experience.push({ jobTitle, company, startDate, endDate, description });
        }
    });
    
    // Education
    data.education = [];
    document.querySelectorAll('.education-item').forEach(item => {
        const degree = item.querySelector('input[name="degree[]"]').value;
        const school = item.querySelector('input[name="school[]"]').value;
        const gradYearRaw = item.querySelector('input[name="gradYear[]"]').value;
        const gpa = item.querySelector('input[name="gpa[]"]').value;
        const gradYear = normalizeYear(gradYearRaw);
        
        if (degree && school) {
            data.education.push({ degree, school, gradYear, gpa });
        }
    });
    
    // Projects
    data.projects = [];
    document.querySelectorAll('.project-item').forEach(item => {
        const name = item.querySelector('input[name="projectName[]"]').value;
        const url = item.querySelector('input[name="projectUrl[]"]').value;
        const description = item.querySelector('textarea[name="projectDescription[]"]').value;
        
        if (name) {
            data.projects.push({ name, url, description });
        }
    });
    
    data.skills = skills;
    
    // Update preview
    document.getElementById('previewName').textContent = `${data.firstName} ${data.lastName}`;
    document.getElementById('previewContact').textContent = `${data.email} • ${data.phone} • ${data.location}`;
    document.getElementById('previewSummary').textContent = data.summary || 'Your professional summary will appear here...';
    
    // Experience
    const experienceHtml = data.experience.map(exp => `
        <div class="mb-3">
            <h6 class="mb-1">${exp.jobTitle} at ${exp.company}</h6>
            <p class="text-muted mb-1">${exp.startDate} - ${exp.endDate}</p>
            <p class="mb-0">${exp.description}</p>
        </div>
    `).join('');
    document.getElementById('previewExperience').innerHTML = experienceHtml || 'Your work experience will appear here...';
    
    // Education
    const educationHtml = data.education.map(edu => `
        <div class="mb-3">
            <h6 class="mb-1">${edu.degree}</h6>
            <p class="text-muted mb-1">${edu.school} ${edu.gradYear ? `(${edu.gradYear})` : ''}</p>
            ${edu.gpa ? `<p class="mb-0">GPA: ${edu.gpa}</p>` : ''}
        </div>
    `).join('');
    document.getElementById('previewEducation').innerHTML = educationHtml || 'Your education will appear here...';
    
    // Skills
    document.getElementById('previewSkills').innerHTML = skills.length > 0 ? 
        skills.map(skill => `<span class="badge bg-primary me-1 mb-1">${skill}</span>`).join('') : 
        'Your skills will appear here...';
    
    // Projects
    const projectsHtml = data.projects.map(project => `
        <div class="mb-3">
            <h6 class="mb-1">${project.name}</h6>
            ${project.url ? `<p class="text-muted mb-1"><a href="${project.url}" target="_blank">${project.url}</a></p>` : ''}
            <p class="mb-0">${project.description}</p>
        </div>
    `).join('');
    document.getElementById('previewProjects').innerHTML = projectsHtml || 'Your projects will appear here...';
    
    resumeData = data;
    applyFonts();
}

// Helpers: normalize dates
function normalizeMonthYear(value, allowPresent=false){
    const v = (value || '').trim();
    if (!v) return '';
    if (allowPresent && /present/i.test(v)) return 'Present';
    // Accept formats like MM/YYYY, M/YYYY, YYYY-MM, YYYY/MM, YYYY
    const mmYYYY = /^(\d{1,2})\s*[\/-]\s*(\d{4})$/;
    const yyyyMM = /^(\d{4})\s*[\/-]\s*(\d{1,2})$/;
    const yyyyOnly = /^(\d{4})$/;
    let m, y;
    if (mmYYYY.test(v)) {
        const m1 = v.match(mmYYYY);
        m = String(Math.min(12, Math.max(1, parseInt(m1[1], 10)))).padStart(2,'0');
        y = m1[2];
        return `${m}/${y}`;
    }
    if (yyyyMM.test(v)) {
        const m2 = v.match(yyyyMM);
        y = m2[1];
        m = String(Math.min(12, Math.max(1, parseInt(m2[2], 10)))).padStart(2,'0');
        return `${m}/${y}`;
    }
    if (yyyyOnly.test(v)) {
        return `01/${v}`;
    }
    return v; // fallback
}

function normalizeYear(value){
    const v = (value || '').trim();
    const yyyy = /^(\d{4})$/;
    const mmYYYY = /^(\d{1,2})\s*[\/-]\s*(\d{4})$/;
    if (yyyy.test(v)) return v;
    if (mmYYYY.test(v)) return v.match(mmYYYY)[2];
    return v;
}

function generateResume() {
    // Ensure preview reflects latest data
    updatePreview();
    showMessage('Preview updated. You can download/print using the button.', 'success');
}

// Apply fonts live
document.addEventListener('input', function(e){
    if(e.target && (e.target.id === 'fontName' || e.target.id === 'fontHeadings' || e.target.id === 'fontBody')){
        applyFonts();
    }
});

document.getElementById('downloadBtn').addEventListener('click', function(){
    window.print();
});

document.getElementById('aiGenerateBtn').addEventListener('click', async function(){
    // Minimal payload from basic info
    const payload = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value
    };

    try{
        const res = await fetch('/api/resume/ai-generate', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'Failed to generate');

        // Populate form with AI result
        fillFormFromAI(data.resume || {});
        updatePreview();
        showMessage('AI generated a starter resume. Review and edit as needed.', 'success');
    }catch(err){
        console.error(err);
        showMessage('AI generation failed. Using a local template.', 'warning');
        // Local fallback
        fillFormFromAI(localResumeTemplate(payload));
        updatePreview();
    }
});

function fillFormFromAI(r){
    // Personal
    if(r.firstName) document.getElementById('firstName').value = r.firstName;
    if(r.lastName) document.getElementById('lastName').value = r.lastName;
    if(r.email) document.getElementById('email').value = r.email;
    if(r.phone) document.getElementById('phone').value = r.phone;
    if(r.location) document.getElementById('location').value = r.location;
    if(r.linkedin) document.getElementById('linkedin').value = r.linkedin;
    if(r.summary) document.getElementById('summary').value = r.summary;

    // Clear and refill dynamic sections
    const expContainer = document.getElementById('experienceContainer');
    expContainer.innerHTML = '';
    (r.experience || []).forEach(exp => {
        addExperience();
        const item = expContainer.lastElementChild;
        item.querySelector('input[name="jobTitle[]"]').value = exp.jobTitle || '';
        item.querySelector('input[name="company[]"]').value = exp.company || '';
        item.querySelector('input[name="startDate[]"]').value = exp.startDate || '';
        item.querySelector('input[name="endDate[]"]').value = exp.endDate || '';
        item.querySelector('textarea[name="description[]"]').value = exp.description || '';
    });

    const eduContainer = document.getElementById('educationContainer');
    eduContainer.innerHTML = '';
    (r.education || []).forEach(edu => {
        addEducation();
        const item = eduContainer.lastElementChild;
        item.querySelector('input[name="degree[]"]').value = edu.degree || '';
        item.querySelector('input[name="school[]"]').value = edu.school || '';
        item.querySelector('input[name="gradYear[]"]').value = edu.gradYear || '';
        item.querySelector('input[name="gpa[]"]').value = edu.gpa || '';
    });

    const projContainer = document.getElementById('projectsContainer');
    projContainer.innerHTML = '';
    (r.projects || []).forEach(p => {
        addProject();
        const item = projContainer.lastElementChild;
        item.querySelector('input[name="projectName[]"]').value = p.name || '';
        item.querySelector('input[name="projectUrl[]"]').value = p.url || '';
        item.querySelector('textarea[name="projectDescription[]"]').value = p.description || '';
    });

    skills = Array.isArray(r.skills) ? r.skills : [];
    updateSkillsDisplay();
}

function localResumeTemplate(payload){
    const fullName = `${payload.firstName || 'John'} ${payload.lastName || 'Doe'}`.trim();
    const now = new Date();
    const gradYear = String(now.getFullYear());
    return {
        firstName: payload.firstName || 'John',
        lastName: payload.lastName || 'Doe',
        email: payload.email || 'john.doe@example.com',
        phone: payload.phone || '+1-555-555-5555',
        location: 'Your City, Country',
        linkedin: 'https://www.linkedin.com/in/your-profile',
        summary: `Motivated software developer seeking opportunities. Strong fundamentals, project experience, and a passion for learning.`,
        experience: [
            {
                jobTitle: 'Software Engineering Intern',
                company: 'Tech Corp',
                startDate: '06/2024',
                endDate: '08/2024',
                description: 'Built features with React and Flask. Improved page performance by 25%. Wrote unit tests.'
            }
        ],
        education: [
            { degree: 'B.Tech in Computer Science', school: 'ABC University', gradYear: gradYear, gpa: '8.2/10' }
        ],
        skills: ['Python', 'Flask', 'JavaScript', 'React', 'SQL'],
        projects: [
            { name: 'Portfolio Website', url: 'https://yourdomain.com', description: 'Personal portfolio with responsive UI and contact form.' }
        ]
    };
}

function applyFonts(){
    const nameFont = document.getElementById('fontName').value;
    const headingFont = document.getElementById('fontHeadings').value;
    const bodyFont = document.getElementById('fontBody').value;
    
    document.getElementById('previewName').style.fontFamily = nameFont;
    document.querySelectorAll('.preview-section h5').forEach(h => h.style.fontFamily = headingFont);
    document.getElementById('resumePreview').style.fontFamily = bodyFont;
}

function showMessage(message, type) {
    const alertClass = type === 'error' ? 'danger' : type;
    const alertHtml = `
        <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert at the top of the container
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            const alertInstance = new bootstrap.Alert(alert);
            alertInstance.close();
        }
    }, 5000);
}

</script>

{% endblock %}
